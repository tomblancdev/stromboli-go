name: Update Licenses

on:
  push:
    branches: [main]
    paths:
      - 'go.mod'
      - 'go.sum'
  schedule:
    # Weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-licenses:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      - name: Generate license report
        run: |
          go-licenses report ./... 2>/dev/null | sort > licenses.txt || true

      - name: Update THIRD_PARTY.md
        run: |
          cat > THIRD_PARTY.md << 'HEADER'
          # Third-Party Licenses

          This file lists the third-party dependencies used by stromboli-go and their licenses.

          All dependencies use permissive open-source licenses compatible with the MIT license.

          ## Dependencies

          | Package | License | Source |
          |---------|---------|--------|
          HEADER

          # Parse licenses.txt and generate table rows
          while IFS=, read -r package url license; do
            # Skip our own package
            if [[ "$package" == "github.com/tomblancdev/stromboli-go" ]]; then
              continue
            fi
            # Clean up package name (remove subpackages for cleaner display)
            base_package=$(echo "$package" | sed 's|/v[0-9]*$||')
            echo "| $base_package | $license | [LICENSE]($url) |" >> THIRD_PARTY.md
          done < licenses.txt

          # Add summary
          cat >> THIRD_PARTY.md << 'FOOTER'

          ## License Summary

          | License | Count |
          |---------|-------|
          FOOTER

          # Count licenses
          cut -d',' -f3 licenses.txt | sort | uniq -c | sort -rn | while read count license; do
            echo "| $license | $count |" >> THIRD_PARTY.md
          done

          cat >> THIRD_PARTY.md << 'END'

          ## Updating This File

          This file is automatically updated by GitHub Actions when dependencies change.

          To manually regenerate, run:

          ```bash
          make licenses
          ```

          ---

          *Auto-generated by [licenses.yml](/.github/workflows/licenses.yml)*
          END

          rm licenses.txt

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet THIRD_PARTY.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update third-party licenses'
          title: 'chore: update third-party licenses'
          body: |
            Automated update of `THIRD_PARTY.md` based on current dependencies.

            This PR was automatically created by the [licenses workflow](/.github/workflows/licenses.yml).
          branch: chore/update-licenses
          delete-branch: true
          labels: dependencies
