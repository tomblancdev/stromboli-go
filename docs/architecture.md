# Architecture

## Overview

The Stromboli Go SDK follows a two-layer architecture:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      User Code                               â”‚
â”‚                          â”‚                                   â”‚
â”‚                          â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Wrapper Layer (client.go, options.go, errors.go)   â”‚    â”‚
â”‚  â”‚  â€¢ Clean, idiomatic Go API                          â”‚    â”‚
â”‚  â”‚  â€¢ Context support                                  â”‚    â”‚
â”‚  â”‚  â€¢ Retries, timeouts                                â”‚    â”‚
â”‚  â”‚  â€¢ Error handling                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                         â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Generated Layer (generated/)                        â”‚    â”‚
â”‚  â”‚  â€¢ Auto-generated from OpenAPI spec                 â”‚    â”‚
â”‚  â”‚  â€¢ Raw HTTP client                                  â”‚    â”‚
â”‚  â”‚  â€¢ Type-safe request/response models                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTP/HTTPS
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Stromboli API  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Directory Structure

```
stromboli-go/
â”œâ”€â”€ client.go           # High-level client wrapper
â”œâ”€â”€ options.go          # Functional options (WithTimeout, etc.)
â”œâ”€â”€ errors.go           # Error types and sentinels
â”œâ”€â”€ version.go          # SDK version constant
â”œâ”€â”€ stromboli.go        # Package documentation
â”œâ”€â”€ stromboli.yaml      # API version configuration
â”‚
â”œâ”€â”€ generated/          # ğŸ¤– AUTO-GENERATED (never edit)
â”‚   â”œâ”€â”€ client/         # HTTP client by API endpoint group
â”‚   â”‚   â”œâ”€â”€ auth/       # Authentication endpoints
â”‚   â”‚   â”œâ”€â”€ execution/  # Claude execution endpoints
â”‚   â”‚   â”œâ”€â”€ jobs/       # Async job management
â”‚   â”‚   â”œâ”€â”€ secrets/    # Secrets endpoints
â”‚   â”‚   â”œâ”€â”€ sessions/   # Session management
â”‚   â”‚   â””â”€â”€ system/     # Health and status
â”‚   â”œâ”€â”€ models/         # Request/response Go structs
â”‚   â””â”€â”€ swagger.yaml    # Normalized OpenAPI spec
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ generate.go     # Code generation script
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/           # Unit tests
â”‚   â””â”€â”€ e2e/            # End-to-end tests
â”‚
â”œâ”€â”€ docs/               # Documentation
â”œâ”€â”€ Containerfile       # Development container
â”œâ”€â”€ Makefile            # Build commands
â””â”€â”€ .golangci.yml       # Linter configuration
```

## Code Generation

The SDK uses [go-swagger](https://github.com/go-swagger/go-swagger) to generate type-safe client code from the Stromboli OpenAPI specification.

### Flow

```
stromboli.yaml (apiVersion)
        â”‚
        â–¼
scripts/generate.go
        â”‚
        â”œâ”€â–º Fetch swagger.yaml from GitHub release
        â”‚
        â”œâ”€â–º Normalize definition names (remove Go package prefixes)
        â”‚
        â””â”€â–º Run: swagger generate client
                    â”‚
                    â–¼
            generated/
            â”œâ”€â”€ client/
            â””â”€â”€ models/
```

### Why Normalization?

Stromboli's swagger spec is generated by [swaggo](https://github.com/swaggo/swag), which includes Go package names in definitions:

```yaml
# Before normalization
$ref: '#/definitions/internal_api.RunRequest'

# After normalization
$ref: '#/definitions/RunRequest'
```

## Design Principles

### 1. OpenAPI-First

Never manually write API types or endpoints. Always regenerate from the spec:

```bash
make generate
```

### 2. Thin Wrapper

The wrapper layer adds only:
- Context support
- Functional options
- Retry logic
- Error normalization

It does NOT add business logic or transform data.

### 3. Stdlib First

Prefer Go standard library. External dependencies are added only when necessary.

### 4. Container Development

All development commands run in Podman containers for consistency:

```bash
make test    # Runs in container
make lint    # Runs in container
make build   # Runs in container
```
